package sdkv2provider

import (
	"fmt"
	"regexp"
	"testing"

	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/resource"
	"github.com/hashicorp/terraform-plugin-sdk/v2/terraform"
)

const (
	CertificatePem = `
-----BEGIN CERTIFICATE-----
MIIF6TCCBNGgAwIBAgIUUb0TUS5XT1JP/EZCLjNWYAv6wtIwDQYJKoZIhvcNAQEL
BQAwdTELMAkGA1UEBhMCVUsxEDAOBgNVBAgTB0VuZ2xhbmQxDzANBgNVBAcTBkxv
bmRvbjEQMA4GA1UEChMHcmFpZGlhbTEQMA4GA1UECxMHUmFpZGlhbTEfMB0GA1UE
AxMWUmFpZGlhbSBSb290IERFTU8gLSBHMTAeFw0yMTA5MjAxNTU5MDBaFw0yNjA5
MjAxNTU5MDBaMHsxCzAJBgNVBAYTAlVLMRAwDgYDVQQIEwdFbmdsYW5kMQ8wDQYD
VQQHEwZMb25kb24xEDAOBgNVBAoTB3JhaWRpYW0xEDAOBgNVBAsTB1JhaWRpYW0x
JTAjBgNVBAMTHFJhaWRpYW0gREVNTyBJc3N1aW5nIENBIC0gRzEwggEiMA0GCSqG
SIb3DQEBAQUAA4IBDwAwggEKAoIBAQDFqVGP4sTd0h9X+ydPOY204o6NKXZvXj9P
1wk6BIVWqYtclr/Nycif6qW2iMdBENxDLKJaQAIg675uz1m7JPM6eI9gajqVeKSS
INPt4FWEMfNk8Oldvu+eSB095Lm1SyGbwU4Rk/1lYpgh0qJBrVWTBKsL4e3iTRKe
BK1y6pbOYWcJfeI/NfOMj7PH/jNnuIdj9sPdcgmGhtqpj8oD+lGKf27og5w5TtiE
O5PoMptwpSD44k2iNlRbV4K8iE8FMQIR98Ltoi7oqHME0dyTnmMHDMRtRbBQoz6T
/tbrTAkkUlQlF5Oagq5MDdj5ES3P6KtI54QAZuQRLxmZq63/Gi3JAgMBAAGjggJp
MIICZTAOBgNVHQ8BAf8EBAMCAQYwEgYDVR0TAQH/BAgwBgEB/wIBADAdBgNVHQ4E
FgQUvy9fU9MRyBu6DByH3nDMzV60LM0wHwYDVR0jBBgwFoAUym3xXMoIOEqPJc/s
fINzn5XRKhQwNwYIKwYBBQUHAQEEKzApMCcGCCsGAQUFBzABhhtodHRwOi8vb2Nz
cC5kZW1vLnJhaWRpYW0uaW8wNgYDVR0fBC8wLTAroCmgJ4YlaHR0cDovL2NybC5k
ZW1vLnJhaWRpYW0uaW8vaXNzdWVyLmNybDCCAYwGA1UdIASCAYMwggF/MIIBewYK
KwYBBAGDui9kATCCAWswggE2BggrBgEFBQcCAjCCASgMggEkVGhpcyBDZXJ0aWZp
Y2F0ZSBpcyBzb2xlbHkgZm9yIHVzZSB3aXRoIFJhaWRpYW0gU2VydmljZXMgTGlt
aXRlZCBhbmQgb3RoZXIgcGFydGljaXBhdGluZyBvcmdhbmlzYXRpb25zIHVzaW5n
IFJhaWRpYW0gU2VydmljZXMgTGltaXRlZHMgVHJ1c3QgRnJhbWV3b3JrIFNlcnZp
Y2VzLiBJdHMgcmVjZWlwdCwgcG9zc2Vzc2lvbiBvciB1c2UgY29uc3RpdHV0ZXMg
YWNjZXB0YW5jZSBvZiB0aGUgUmFpZGlhbSBTZXJ2aWNlcyBMdGQgQ2VydGljaWNh
dGUgUG9saWN5IGFuZCByZWxhdGVkIGRvY3VtZW50cyB0aGVyZWluLjAvBggrBgEF
BQcCARYjaHR0cDovL2Nwcy5kZW1vLnJhaWRpYW0uaW8vcG9saWNpZXMwDQYJKoZI
hvcNAQELBQADggEBAG4okG8FbUA3CPs5WZ91tR42HETV1dhQ2xEK98E7vZiiW/j4
BxOYHE5Nubxtr196vQ9gPAipt1/Bt3wpO1TloYUs5IPHbosYgHthdwQBapl39/YC
hi1ukl5uJx8F+8MCzLZhqfsN106vazgLPBmAHxSabcpikNcRAZVTiCM5HQa8Nq2g
DOSTA0gVxhy0WFFA73ZGM7mxhk1WO5iwvz3BNUJtTuWVuEGuJREg9ffmu7Az9HI+
qKCXwvYMUg37RUM3IiS2vv56HJtyLG+EuJn4YIOy+Y1zzX7fIDfnwIE1V7a05oFa
tiMEtoLvP4ECKYNuFauGb4JZspcneEoyZXiCpRw=
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIDujCCAqKgAwIBAgIUdsLKEuCH3vMu/nUo55XTi8r9tP0wDQYJKoZIhvcNAQEL
BQAwdTELMAkGA1UEBhMCVUsxEDAOBgNVBAgTB0VuZ2xhbmQxDzANBgNVBAcTBkxv
bmRvbjEQMA4GA1UEChMHcmFpZGlhbTEQMA4GA1UECxMHUmFpZGlhbTEfMB0GA1UE
AxMWUmFpZGlhbSBSb290IERFTU8gLSBHMTAeFw0yMTA5MjAxNTU5MDBaFw0yNjA5
MTkxNTU5MDBaMHUxCzAJBgNVBAYTAlVLMRAwDgYDVQQIEwdFbmdsYW5kMQ8wDQYD
VQQHEwZMb25kb24xEDAOBgNVBAoTB3JhaWRpYW0xEDAOBgNVBAsTB1JhaWRpYW0x
HzAdBgNVBAMTFlJhaWRpYW0gUm9vdCBERU1PIC0gRzEwggEiMA0GCSqGSIb3DQEB
AQUAA4IBDwAwggEKAoIBAQCt/H52w1sVk0fWZtCv4ynl2sHwdONbdvpsyf/FYpIX
WN0DQa6if1spckB5K8aVuUjqno/U6GCjGI1ucdOrLOB8CGXpTNNoWo+jfRkRl0qt
4FL4V2ubipcx9X9L/S8BUtD/z8FhV58D2k35nyy9EXwg+wAdQ8IikyE1kcU/AduG
wi0IP1YADPaU5q33B/cwzOtZ6eK7GncZ3jIHQ7SVczSyCSLtUczm0bsgnwOG3+5t
vW2S+Yx0Rfug5u2686LoGd+Mpr3y/ohBg5QeYRsNiopy+WTDLwkUVLmbcO7/tj9K
kwka/Gv1whXbAmN6RObYC+AFw7JIJZzSfbkiWhC4ZB59AgMBAAGjQjBAMA4GA1Ud
DwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBTKbfFcygg4So8l
z+x8g3OfldEqFDANBgkqhkiG9w0BAQsFAAOCAQEAUPfBDQbdIDxN990G85i5kmUw
6MdPKU2kxLTZukRUX/Lc3cEGprOpAO8sisgSnIJ9KfCNlouEu74DlwhsYr9E1aaA
S7b5b2bauIttJ0Xtj+wRz1TDmIqQKpMppQLcuvXLLRPy/1K38Ol4LVkaoWiOep1e
S+OPx9DX+JwTI1CZavAWX9INmRFqyl7qOY6eAqaxtiAeRc3YkE6B42DEFiB0n0lG
/CAgjtwmB1qymTo3IDZS0rjj+R7n4NbnUzIoE9L/dwkPqW8F2pRvvoX3lJ9LnFla
zEzzNt1/VqOwpTs40gW60r4etSsy5ZMQWHuOhGtqftRdHTxjxIjvvk1XFYoTDg==
-----END CERTIFICATE-----
`

	SingleCertificatePem = `
-----BEGIN CERTIFICATE-----
MIIDujCCAqKgAwIBAgIUdsLKEuCH3vMu/nUo55XTi8r9tP0wDQYJKoZIhvcNAQEL
BQAwdTELMAkGA1UEBhMCVUsxEDAOBgNVBAgTB0VuZ2xhbmQxDzANBgNVBAcTBkxv
bmRvbjEQMA4GA1UEChMHcmFpZGlhbTEQMA4GA1UECxMHUmFpZGlhbTEfMB0GA1UE
AxMWUmFpZGlhbSBSb290IERFTU8gLSBHMTAeFw0yMTA5MjAxNTU5MDBaFw0yNjA5
MTkxNTU5MDBaMHUxCzAJBgNVBAYTAlVLMRAwDgYDVQQIEwdFbmdsYW5kMQ8wDQYD
VQQHEwZMb25kb24xEDAOBgNVBAoTB3JhaWRpYW0xEDAOBgNVBAsTB1JhaWRpYW0x
HzAdBgNVBAMTFlJhaWRpYW0gUm9vdCBERU1PIC0gRzEwggEiMA0GCSqGSIb3DQEB
AQUAA4IBDwAwggEKAoIBAQCt/H52w1sVk0fWZtCv4ynl2sHwdONbdvpsyf/FYpIX
WN0DQa6if1spckB5K8aVuUjqno/U6GCjGI1ucdOrLOB8CGXpTNNoWo+jfRkRl0qt
4FL4V2ubipcx9X9L/S8BUtD/z8FhV58D2k35nyy9EXwg+wAdQ8IikyE1kcU/AduG
wi0IP1YADPaU5q33B/cwzOtZ6eK7GncZ3jIHQ7SVczSyCSLtUczm0bsgnwOG3+5t
vW2S+Yx0Rfug5u2686LoGd+Mpr3y/ohBg5QeYRsNiopy+WTDLwkUVLmbcO7/tj9K
kwka/Gv1whXbAmN6RObYC+AFw7JIJZzSfbkiWhC4ZB59AgMBAAGjQjBAMA4GA1Ud
DwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBTKbfFcygg4So8l
z+x8g3OfldEqFDANBgkqhkiG9w0BAQsFAAOCAQEAUPfBDQbdIDxN990G85i5kmUw
6MdPKU2kxLTZukRUX/Lc3cEGprOpAO8sisgSnIJ9KfCNlouEu74DlwhsYr9E1aaA
S7b5b2bauIttJ0Xtj+wRz1TDmIqQKpMppQLcuvXLLRPy/1K38Ol4LVkaoWiOep1e
S+OPx9DX+JwTI1CZavAWX9INmRFqyl7qOY6eAqaxtiAeRc3YkE6B42DEFiB0n0lG
/CAgjtwmB1qymTo3IDZS0rjj+R7n4NbnUzIoE9L/dwkPqW8F2pRvvoX3lJ9LnFla
zEzzNt1/VqOwpTs40gW60r4etSsy5ZMQWHuOhGtqftRdHTxjxIjvvk1XFYoTDg==
-----END CERTIFICATE-----
`

	WrongOrderCertificatePem = `
-----BEGIN CERTIFICATE-----
MIIDujCCAqKgAwIBAgIUdsLKEuCH3vMu/nUo55XTi8r9tP0wDQYJKoZIhvcNAQEL
BQAwdTELMAkGA1UEBhMCVUsxEDAOBgNVBAgTB0VuZ2xhbmQxDzANBgNVBAcTBkxv
bmRvbjEQMA4GA1UEChMHcmFpZGlhbTEQMA4GA1UECxMHUmFpZGlhbTEfMB0GA1UE
AxMWUmFpZGlhbSBSb290IERFTU8gLSBHMTAeFw0yMTA5MjAxNTU5MDBaFw0yNjA5
MTkxNTU5MDBaMHUxCzAJBgNVBAYTAlVLMRAwDgYDVQQIEwdFbmdsYW5kMQ8wDQYD
VQQHEwZMb25kb24xEDAOBgNVBAoTB3JhaWRpYW0xEDAOBgNVBAsTB1JhaWRpYW0x
HzAdBgNVBAMTFlJhaWRpYW0gUm9vdCBERU1PIC0gRzEwggEiMA0GCSqGSIb3DQEB
AQUAA4IBDwAwggEKAoIBAQCt/H52w1sVk0fWZtCv4ynl2sHwdONbdvpsyf/FYpIX
WN0DQa6if1spckB5K8aVuUjqno/U6GCjGI1ucdOrLOB8CGXpTNNoWo+jfRkRl0qt
4FL4V2ubipcx9X9L/S8BUtD/z8FhV58D2k35nyy9EXwg+wAdQ8IikyE1kcU/AduG
wi0IP1YADPaU5q33B/cwzOtZ6eK7GncZ3jIHQ7SVczSyCSLtUczm0bsgnwOG3+5t
vW2S+Yx0Rfug5u2686LoGd+Mpr3y/ohBg5QeYRsNiopy+WTDLwkUVLmbcO7/tj9K
kwka/Gv1whXbAmN6RObYC+AFw7JIJZzSfbkiWhC4ZB59AgMBAAGjQjBAMA4GA1Ud
DwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBTKbfFcygg4So8l
z+x8g3OfldEqFDANBgkqhkiG9w0BAQsFAAOCAQEAUPfBDQbdIDxN990G85i5kmUw
6MdPKU2kxLTZukRUX/Lc3cEGprOpAO8sisgSnIJ9KfCNlouEu74DlwhsYr9E1aaA
S7b5b2bauIttJ0Xtj+wRz1TDmIqQKpMppQLcuvXLLRPy/1K38Ol4LVkaoWiOep1e
S+OPx9DX+JwTI1CZavAWX9INmRFqyl7qOY6eAqaxtiAeRc3YkE6B42DEFiB0n0lG
/CAgjtwmB1qymTo3IDZS0rjj+R7n4NbnUzIoE9L/dwkPqW8F2pRvvoX3lJ9LnFla
zEzzNt1/VqOwpTs40gW60r4etSsy5ZMQWHuOhGtqftRdHTxjxIjvvk1XFYoTDg==
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIF6TCCBNGgAwIBAgIUUb0TUS5XT1JP/EZCLjNWYAv6wtIwDQYJKoZIhvcNAQEL
BQAwdTELMAkGA1UEBhMCVUsxEDAOBgNVBAgTB0VuZ2xhbmQxDzANBgNVBAcTBkxv
bmRvbjEQMA4GA1UEChMHcmFpZGlhbTEQMA4GA1UECxMHUmFpZGlhbTEfMB0GA1UE
AxMWUmFpZGlhbSBSb290IERFTU8gLSBHMTAeFw0yMTA5MjAxNTU5MDBaFw0yNjA5
MjAxNTU5MDBaMHsxCzAJBgNVBAYTAlVLMRAwDgYDVQQIEwdFbmdsYW5kMQ8wDQYD
VQQHEwZMb25kb24xEDAOBgNVBAoTB3JhaWRpYW0xEDAOBgNVBAsTB1JhaWRpYW0x
JTAjBgNVBAMTHFJhaWRpYW0gREVNTyBJc3N1aW5nIENBIC0gRzEwggEiMA0GCSqG
SIb3DQEBAQUAA4IBDwAwggEKAoIBAQDFqVGP4sTd0h9X+ydPOY204o6NKXZvXj9P
1wk6BIVWqYtclr/Nycif6qW2iMdBENxDLKJaQAIg675uz1m7JPM6eI9gajqVeKSS
INPt4FWEMfNk8Oldvu+eSB095Lm1SyGbwU4Rk/1lYpgh0qJBrVWTBKsL4e3iTRKe
BK1y6pbOYWcJfeI/NfOMj7PH/jNnuIdj9sPdcgmGhtqpj8oD+lGKf27og5w5TtiE
O5PoMptwpSD44k2iNlRbV4K8iE8FMQIR98Ltoi7oqHME0dyTnmMHDMRtRbBQoz6T
/tbrTAkkUlQlF5Oagq5MDdj5ES3P6KtI54QAZuQRLxmZq63/Gi3JAgMBAAGjggJp
MIICZTAOBgNVHQ8BAf8EBAMCAQYwEgYDVR0TAQH/BAgwBgEB/wIBADAdBgNVHQ4E
FgQUvy9fU9MRyBu6DByH3nDMzV60LM0wHwYDVR0jBBgwFoAUym3xXMoIOEqPJc/s
fINzn5XRKhQwNwYIKwYBBQUHAQEEKzApMCcGCCsGAQUFBzABhhtodHRwOi8vb2Nz
cC5kZW1vLnJhaWRpYW0uaW8wNgYDVR0fBC8wLTAroCmgJ4YlaHR0cDovL2NybC5k
ZW1vLnJhaWRpYW0uaW8vaXNzdWVyLmNybDCCAYwGA1UdIASCAYMwggF/MIIBewYK
KwYBBAGDui9kATCCAWswggE2BggrBgEFBQcCAjCCASgMggEkVGhpcyBDZXJ0aWZp
Y2F0ZSBpcyBzb2xlbHkgZm9yIHVzZSB3aXRoIFJhaWRpYW0gU2VydmljZXMgTGlt
aXRlZCBhbmQgb3RoZXIgcGFydGljaXBhdGluZyBvcmdhbmlzYXRpb25zIHVzaW5n
IFJhaWRpYW0gU2VydmljZXMgTGltaXRlZHMgVHJ1c3QgRnJhbWV3b3JrIFNlcnZp
Y2VzLiBJdHMgcmVjZWlwdCwgcG9zc2Vzc2lvbiBvciB1c2UgY29uc3RpdHV0ZXMg
YWNjZXB0YW5jZSBvZiB0aGUgUmFpZGlhbSBTZXJ2aWNlcyBMdGQgQ2VydGljaWNh
dGUgUG9saWN5IGFuZCByZWxhdGVkIGRvY3VtZW50cyB0aGVyZWluLjAvBggrBgEF
BQcCARYjaHR0cDovL2Nwcy5kZW1vLnJhaWRpYW0uaW8vcG9saWNpZXMwDQYJKoZI
hvcNAQELBQADggEBAG4okG8FbUA3CPs5WZ91tR42HETV1dhQ2xEK98E7vZiiW/j4
BxOYHE5Nubxtr196vQ9gPAipt1/Bt3wpO1TloYUs5IPHbosYgHthdwQBapl39/YC
hi1ukl5uJx8F+8MCzLZhqfsN106vazgLPBmAHxSabcpikNcRAZVTiCM5HQa8Nq2g
DOSTA0gVxhy0WFFA73ZGM7mxhk1WO5iwvz3BNUJtTuWVuEGuJREg9ffmu7Az9HI+
qKCXwvYMUg37RUM3IiS2vv56HJtyLG+EuJn4YIOy+Y1zzX7fIDfnwIE1V7a05oFa
tiMEtoLvP4ECKYNuFauGb4JZspcneEoyZXiCpRw=
-----END CERTIFICATE-----
`
)

func TestAccJwksFromCertificateDataSource(t *testing.T) {
	resourceName := "data.jwks_from_certificate.test"

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV5ProviderFactories: testAccProviders,
		CheckDestroy:             testAccCheckJwksFromCertificateDataSourceDestroy,
		Steps: []resource.TestStep{
			{
				Config: testAccJwksFromCertificateDataSourceConfig(CertificatePem),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(resourceName, "jwks", "{\"e\":\"AQAB\",\"kid\":\"EDuNyHAukWgl5aLPNyf3Z8ampp4BYE13J+AqKZdeB28=\",\"kty\":\"RSA\",\"n\":\"xalRj-LE3dIfV_snTzmNtOKOjSl2b14_T9cJOgSFVqmLXJa_zcnIn-qltojHQRDcQyyiWkACIOu-bs9ZuyTzOniPYGo6lXikkiDT7eBVhDHzZPDpXb7vnkgdPeS5tUshm8FOEZP9ZWKYIdKiQa1VkwSrC-Ht4k0SngStcuqWzmFnCX3iPzXzjI-zx_4zZ7iHY_bD3XIJhobaqY_KA_pRin9u6IOcOU7YhDuT6DKbcKUg-OJNojZUW1eCvIhPBTECEffC7aIu6KhzBNHck55jBwzEbUWwUKM-k_7W60wJJFJUJReTmoKuTA3Y-REtz-irSOeEAGbkES8Zmaut_xotyQ\",\"x5c\":[\"MIIF6TCCBNGgAwIBAgIUUb0TUS5XT1JP/EZCLjNWYAv6wtIwDQYJKoZIhvcNAQELBQAwdTELMAkGA1UEBhMCVUsxEDAOBgNVBAgTB0VuZ2xhbmQxDzANBgNVBAcTBkxvbmRvbjEQMA4GA1UEChMHcmFpZGlhbTEQMA4GA1UECxMHUmFpZGlhbTEfMB0GA1UEAxMWUmFpZGlhbSBSb290IERFTU8gLSBHMTAeFw0yMTA5MjAxNTU5MDBaFw0yNjA5MjAxNTU5MDBaMHsxCzAJBgNVBAYTAlVLMRAwDgYDVQQIEwdFbmdsYW5kMQ8wDQYDVQQHEwZMb25kb24xEDAOBgNVBAoTB3JhaWRpYW0xEDAOBgNVBAsTB1JhaWRpYW0xJTAjBgNVBAMTHFJhaWRpYW0gREVNTyBJc3N1aW5nIENBIC0gRzEwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDFqVGP4sTd0h9X+ydPOY204o6NKXZvXj9P1wk6BIVWqYtclr/Nycif6qW2iMdBENxDLKJaQAIg675uz1m7JPM6eI9gajqVeKSSINPt4FWEMfNk8Oldvu+eSB095Lm1SyGbwU4Rk/1lYpgh0qJBrVWTBKsL4e3iTRKeBK1y6pbOYWcJfeI/NfOMj7PH/jNnuIdj9sPdcgmGhtqpj8oD+lGKf27og5w5TtiEO5PoMptwpSD44k2iNlRbV4K8iE8FMQIR98Ltoi7oqHME0dyTnmMHDMRtRbBQoz6T/tbrTAkkUlQlF5Oagq5MDdj5ES3P6KtI54QAZuQRLxmZq63/Gi3JAgMBAAGjggJpMIICZTAOBgNVHQ8BAf8EBAMCAQYwEgYDVR0TAQH/BAgwBgEB/wIBADAdBgNVHQ4EFgQUvy9fU9MRyBu6DByH3nDMzV60LM0wHwYDVR0jBBgwFoAUym3xXMoIOEqPJc/sfINzn5XRKhQwNwYIKwYBBQUHAQEEKzApMCcGCCsGAQUFBzABhhtodHRwOi8vb2NzcC5kZW1vLnJhaWRpYW0uaW8wNgYDVR0fBC8wLTAroCmgJ4YlaHR0cDovL2NybC5kZW1vLnJhaWRpYW0uaW8vaXNzdWVyLmNybDCCAYwGA1UdIASCAYMwggF/MIIBewYKKwYBBAGDui9kATCCAWswggE2BggrBgEFBQcCAjCCASgMggEkVGhpcyBDZXJ0aWZpY2F0ZSBpcyBzb2xlbHkgZm9yIHVzZSB3aXRoIFJhaWRpYW0gU2VydmljZXMgTGltaXRlZCBhbmQgb3RoZXIgcGFydGljaXBhdGluZyBvcmdhbmlzYXRpb25zIHVzaW5nIFJhaWRpYW0gU2VydmljZXMgTGltaXRlZHMgVHJ1c3QgRnJhbWV3b3JrIFNlcnZpY2VzLiBJdHMgcmVjZWlwdCwgcG9zc2Vzc2lvbiBvciB1c2UgY29uc3RpdHV0ZXMgYWNjZXB0YW5jZSBvZiB0aGUgUmFpZGlhbSBTZXJ2aWNlcyBMdGQgQ2VydGljaWNhdGUgUG9saWN5IGFuZCByZWxhdGVkIGRvY3VtZW50cyB0aGVyZWluLjAvBggrBgEFBQcCARYjaHR0cDovL2Nwcy5kZW1vLnJhaWRpYW0uaW8vcG9saWNpZXMwDQYJKoZIhvcNAQELBQADggEBAG4okG8FbUA3CPs5WZ91tR42HETV1dhQ2xEK98E7vZiiW/j4BxOYHE5Nubxtr196vQ9gPAipt1/Bt3wpO1TloYUs5IPHbosYgHthdwQBapl39/YChi1ukl5uJx8F+8MCzLZhqfsN106vazgLPBmAHxSabcpikNcRAZVTiCM5HQa8Nq2gDOSTA0gVxhy0WFFA73ZGM7mxhk1WO5iwvz3BNUJtTuWVuEGuJREg9ffmu7Az9HI+qKCXwvYMUg37RUM3IiS2vv56HJtyLG+EuJn4YIOy+Y1zzX7fIDfnwIE1V7a05oFatiMEtoLvP4ECKYNuFauGb4JZspcneEoyZXiCpRw=\",\"MIIDujCCAqKgAwIBAgIUdsLKEuCH3vMu/nUo55XTi8r9tP0wDQYJKoZIhvcNAQELBQAwdTELMAkGA1UEBhMCVUsxEDAOBgNVBAgTB0VuZ2xhbmQxDzANBgNVBAcTBkxvbmRvbjEQMA4GA1UEChMHcmFpZGlhbTEQMA4GA1UECxMHUmFpZGlhbTEfMB0GA1UEAxMWUmFpZGlhbSBSb290IERFTU8gLSBHMTAeFw0yMTA5MjAxNTU5MDBaFw0yNjA5MTkxNTU5MDBaMHUxCzAJBgNVBAYTAlVLMRAwDgYDVQQIEwdFbmdsYW5kMQ8wDQYDVQQHEwZMb25kb24xEDAOBgNVBAoTB3JhaWRpYW0xEDAOBgNVBAsTB1JhaWRpYW0xHzAdBgNVBAMTFlJhaWRpYW0gUm9vdCBERU1PIC0gRzEwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCt/H52w1sVk0fWZtCv4ynl2sHwdONbdvpsyf/FYpIXWN0DQa6if1spckB5K8aVuUjqno/U6GCjGI1ucdOrLOB8CGXpTNNoWo+jfRkRl0qt4FL4V2ubipcx9X9L/S8BUtD/z8FhV58D2k35nyy9EXwg+wAdQ8IikyE1kcU/AduGwi0IP1YADPaU5q33B/cwzOtZ6eK7GncZ3jIHQ7SVczSyCSLtUczm0bsgnwOG3+5tvW2S+Yx0Rfug5u2686LoGd+Mpr3y/ohBg5QeYRsNiopy+WTDLwkUVLmbcO7/tj9Kkwka/Gv1whXbAmN6RObYC+AFw7JIJZzSfbkiWhC4ZB59AgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBTKbfFcygg4So8lz+x8g3OfldEqFDANBgkqhkiG9w0BAQsFAAOCAQEAUPfBDQbdIDxN990G85i5kmUw6MdPKU2kxLTZukRUX/Lc3cEGprOpAO8sisgSnIJ9KfCNlouEu74DlwhsYr9E1aaAS7b5b2bauIttJ0Xtj+wRz1TDmIqQKpMppQLcuvXLLRPy/1K38Ol4LVkaoWiOep1eS+OPx9DX+JwTI1CZavAWX9INmRFqyl7qOY6eAqaxtiAeRc3YkE6B42DEFiB0n0lG/CAgjtwmB1qymTo3IDZS0rjj+R7n4NbnUzIoE9L/dwkPqW8F2pRvvoX3lJ9LnFlazEzzNt1/VqOwpTs40gW60r4etSsy5ZMQWHuOhGtqftRdHTxjxIjvvk1XFYoTDg==\"],\"x5t#S256\":\"EDuNyHAukWgl5aLPNyf3Z8ampp4BYE13J+AqKZdeB28=\"}"),
				),
			},
			{
				Config: testAccJwksFromCertificateDataSourceConfig(SingleCertificatePem),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(resourceName, "jwks", "{\"e\":\"AQAB\",\"kid\":\"IZbkJobc7ZEyBG8Gc98ImVqsyIrycTgBgi0NCRNIxxc=\",\"kty\":\"RSA\",\"n\":\"rfx-dsNbFZNH1mbQr-Mp5drB8HTjW3b6bMn_xWKSF1jdA0Guon9bKXJAeSvGlblI6p6P1OhgoxiNbnHTqyzgfAhl6UzTaFqPo30ZEZdKreBS-Fdrm4qXMfV_S_0vAVLQ_8_BYVefA9pN-Z8svRF8IPsAHUPCIpMhNZHFPwHbhsItCD9WAAz2lOat9wf3MMzrWeniuxp3Gd4yB0O0lXM0sgki7VHM5tG7IJ8Dht_ubb1tkvmMdEX7oObtuvOi6BnfjKa98v6IQYOUHmEbDYqKcvlkwy8JFFS5m3Du_7Y_SpMJGvxr9cIV2wJjekTm2AvgBcOySCWc0n25IloQuGQefQ\",\"x5c\":[\"MIIDujCCAqKgAwIBAgIUdsLKEuCH3vMu/nUo55XTi8r9tP0wDQYJKoZIhvcNAQELBQAwdTELMAkGA1UEBhMCVUsxEDAOBgNVBAgTB0VuZ2xhbmQxDzANBgNVBAcTBkxvbmRvbjEQMA4GA1UEChMHcmFpZGlhbTEQMA4GA1UECxMHUmFpZGlhbTEfMB0GA1UEAxMWUmFpZGlhbSBSb290IERFTU8gLSBHMTAeFw0yMTA5MjAxNTU5MDBaFw0yNjA5MTkxNTU5MDBaMHUxCzAJBgNVBAYTAlVLMRAwDgYDVQQIEwdFbmdsYW5kMQ8wDQYDVQQHEwZMb25kb24xEDAOBgNVBAoTB3JhaWRpYW0xEDAOBgNVBAsTB1JhaWRpYW0xHzAdBgNVBAMTFlJhaWRpYW0gUm9vdCBERU1PIC0gRzEwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCt/H52w1sVk0fWZtCv4ynl2sHwdONbdvpsyf/FYpIXWN0DQa6if1spckB5K8aVuUjqno/U6GCjGI1ucdOrLOB8CGXpTNNoWo+jfRkRl0qt4FL4V2ubipcx9X9L/S8BUtD/z8FhV58D2k35nyy9EXwg+wAdQ8IikyE1kcU/AduGwi0IP1YADPaU5q33B/cwzOtZ6eK7GncZ3jIHQ7SVczSyCSLtUczm0bsgnwOG3+5tvW2S+Yx0Rfug5u2686LoGd+Mpr3y/ohBg5QeYRsNiopy+WTDLwkUVLmbcO7/tj9Kkwka/Gv1whXbAmN6RObYC+AFw7JIJZzSfbkiWhC4ZB59AgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBTKbfFcygg4So8lz+x8g3OfldEqFDANBgkqhkiG9w0BAQsFAAOCAQEAUPfBDQbdIDxN990G85i5kmUw6MdPKU2kxLTZukRUX/Lc3cEGprOpAO8sisgSnIJ9KfCNlouEu74DlwhsYr9E1aaAS7b5b2bauIttJ0Xtj+wRz1TDmIqQKpMppQLcuvXLLRPy/1K38Ol4LVkaoWiOep1eS+OPx9DX+JwTI1CZavAWX9INmRFqyl7qOY6eAqaxtiAeRc3YkE6B42DEFiB0n0lG/CAgjtwmB1qymTo3IDZS0rjj+R7n4NbnUzIoE9L/dwkPqW8F2pRvvoX3lJ9LnFlazEzzNt1/VqOwpTs40gW60r4etSsy5ZMQWHuOhGtqftRdHTxjxIjvvk1XFYoTDg==\"],\"x5t#S256\":\"IZbkJobc7ZEyBG8Gc98ImVqsyIrycTgBgi0NCRNIxxc=\"}"),
				),
			},
			{
				Config: testAccJwksFromCertificateDataSourceWithKidConfig(CertificatePem, "123"),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(resourceName, "jwks", "{\"e\":\"AQAB\",\"kid\":\"123\",\"kty\":\"RSA\",\"n\":\"xalRj-LE3dIfV_snTzmNtOKOjSl2b14_T9cJOgSFVqmLXJa_zcnIn-qltojHQRDcQyyiWkACIOu-bs9ZuyTzOniPYGo6lXikkiDT7eBVhDHzZPDpXb7vnkgdPeS5tUshm8FOEZP9ZWKYIdKiQa1VkwSrC-Ht4k0SngStcuqWzmFnCX3iPzXzjI-zx_4zZ7iHY_bD3XIJhobaqY_KA_pRin9u6IOcOU7YhDuT6DKbcKUg-OJNojZUW1eCvIhPBTECEffC7aIu6KhzBNHck55jBwzEbUWwUKM-k_7W60wJJFJUJReTmoKuTA3Y-REtz-irSOeEAGbkES8Zmaut_xotyQ\",\"x5c\":[\"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\"],\"x5t#S256\":\"EDuNyHAukWgl5aLPNyf3Z8ampp4BYE13J+AqKZdeB28=\"}"),
				),
			},
			{
				Config:      testAccJwksFromCertificateDataSourceConfig(WrongOrderCertificatePem),
				ExpectError: regexp.MustCompile("unable to validate the certificate signature chain"),
			},
		},
	})
}

func testAccCheckJwksFromCertificateDataSourceDestroy(s *terraform.State) error {
	return nil
}

func testAccJwksFromCertificateDataSourceConfig(data string) string {
	return fmt.Sprintf(`
data "jwks_from_certificate" "test" {
  pem = <<EOF
%s
EOF
}
	`, data)
}

func testAccJwksFromCertificateDataSourceWithKidConfig(data string, kid string) string {
	return fmt.Sprintf(`
data "jwks_from_certificate" "test" {
  pem = <<EOF
%s
EOF
  kid = %s
}
	`, data, kid)
}
